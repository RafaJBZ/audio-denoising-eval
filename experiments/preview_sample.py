from __future__ import annotations

import argparse
from pathlib import Path
from random import Random

import torchaudio
from _bootstrap import ensure_project_root_on_path


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description="Create a listenable noisy preview sample.",
    )
    parser.add_argument("--mode", choices=("dynamic", "fixed"), default="dynamic")
    parser.add_argument("--seed", type=int, default=17)
    parser.add_argument("--index", type=int, default=-1, help="Use -1 for random.")
    parser.add_argument("--split", choices=("train", "val", "test"), default="test")
    parser.add_argument(
        "--manifest-path",
        type=Path,
        default=None,
        help="Defaults to <MANIFEST_DIR>/dataset_manifest.csv.",
    )
    parser.add_argument(
        "--fixed-dir",
        type=Path,
        default=Path("experiments/eval_set"),
        help="Directory generated by generate_eval_noisy_set.py when mode=fixed.",
    )
    parser.add_argument(
        "--output-dir",
        type=Path,
        default=Path("experiments/preview"),
    )
    return parser.parse_args()


def _pick_index(size: int, requested_index: int, seed: int) -> int:
    if size <= 0:
        raise ValueError("Cannot pick index from empty collection.")
    if requested_index >= 0:
        if requested_index >= size:
            raise IndexError(f"Requested index {requested_index} out of range [0, {size - 1}]")
        return requested_index
    rng = Random(seed)
    return rng.randrange(0, size)


def _preview_dynamic(args: argparse.Namespace, manifest_path: Path, output_dir: Path) -> None:
    ensure_project_root_on_path()
    from src.config.runtime import load_audio_config
    from src.data.dynamic_mixer import DynamicDenoiseDataset
    from src.data.manifests import read_manifest_csv

    audio_cfg = load_audio_config()
    records = read_manifest_csv(manifest_path)
    speech_records = [record for record in records if record.domain_label == "speech"]
    noise_records = [record for record in records if record.domain_label == "noise"]
    if not speech_records or not noise_records:
        raise RuntimeError("Manifest does not contain both speech and noise records.")
    dataset = DynamicDenoiseDataset(
        speech_records=speech_records,
        noise_records=noise_records,
        audio_cfg=audio_cfg,
        split=args.split,
        seed=args.seed,
    )
    index = _pick_index(len(dataset), args.index, args.seed)
    item = dataset[index]
    output_dir.mkdir(parents=True, exist_ok=True)
    noisy_path = output_dir / "dynamic_noisy.wav"
    clean_path = output_dir / "dynamic_clean.wav"
    torchaudio.save(
        noisy_path.as_posix(),
        item.noisy_waveform,
        sample_rate=audio_cfg.sample_rate_hz,
    )
    torchaudio.save(
        clean_path.as_posix(),
        item.clean_waveform,
        sample_rate=audio_cfg.sample_rate_hz,
    )
    print(f"Saved dynamic noisy sample: {noisy_path}")
    print(f"Saved dynamic clean sample: {clean_path}")
    print(f"SNR(dB): {item.snr_db:.2f}")
    print(f"Listen: ffplay -autoexit {noisy_path}")


def _preview_fixed(args: argparse.Namespace, output_dir: Path) -> None:
    sample_dirs = sorted(
        path for path in args.fixed_dir.glob("sample_*") if path.is_dir()
    )
    if not sample_dirs:
        raise RuntimeError(
            f"No sample_* directories found in {args.fixed_dir}. "
            "Run generate_eval_noisy_set.py first."
        )
    index = _pick_index(len(sample_dirs), args.index, args.seed)
    sample_dir = sample_dirs[index]
    noisy_src = sample_dir / "noisy.wav"
    clean_src = sample_dir / "clean.wav"
    if not noisy_src.exists() or not clean_src.exists():
        raise FileNotFoundError(f"Missing clean/noisy files in {sample_dir}")
    output_dir.mkdir(parents=True, exist_ok=True)
    noisy_out = output_dir / "fixed_noisy.wav"
    clean_out = output_dir / "fixed_clean.wav"
    noisy_wave, noisy_sr = torchaudio.load(noisy_src.as_posix())
    clean_wave, clean_sr = torchaudio.load(clean_src.as_posix())
    torchaudio.save(noisy_out.as_posix(), noisy_wave, noisy_sr)
    torchaudio.save(clean_out.as_posix(), clean_wave, clean_sr)
    print(f"Saved fixed noisy sample: {noisy_out}")
    print(f"Saved fixed clean sample: {clean_out}")
    print(f"Source sample: {sample_dir.name}")
    print(f"Listen: ffplay -autoexit {noisy_out}")


def main() -> None:
    ensure_project_root_on_path()
    from src.config.runtime import load_runtime_paths

    args = parse_args()
    runtime = load_runtime_paths()
    manifest_path = args.manifest_path or (runtime.data_paths.manifest_dir / "dataset_manifest.csv")
    if args.mode == "dynamic":
        if not manifest_path.exists():
            raise FileNotFoundError(
                f"Manifest not found at {manifest_path}. Run: uv run experiments/prepare_data.py"
            )
        _preview_dynamic(args=args, manifest_path=manifest_path, output_dir=args.output_dir)
        return
    _preview_fixed(args=args, output_dir=args.output_dir)


if __name__ == "__main__":
    main()

